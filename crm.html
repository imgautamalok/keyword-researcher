<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Team CRM</title>
<style>
:root{--bg:#0f172a;--bg2:#111827;--card:#1e293b;--card2:#162032;--text:#e2e8f0;--muted:#94a3b8;--border:#1e2d3d;--accent:#6366f1;--accent-l:#818cf8;--success:#22c55e;--warn:#f59e0b;--danger:#ef4444;--sw:240px}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* LOGIN */
#ls{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f172a,#1e1b4b)}
.lb{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px;width:100%;max-width:420px;box-shadow:0 25px 60px rgba(0,0,0,.5)}
.ll{text-align:center;margin-bottom:28px}
.ll h1{font-size:26px;font-weight:800}
.ll p{color:var(--muted);font-size:14px;margin-top:6px}
.hint{background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.2);border-radius:10px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--muted)}
.hint b{color:var(--accent-l)}

/* APP */
#app{display:flex;min-height:100vh}

/* SIDEBAR */
.sb{width:var(--sw);background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;overflow-y:auto;z-index:100}
.sb-logo{padding:18px 16px;border-bottom:1px solid var(--border);font-size:17px;font-weight:800;display:flex;align-items:center;gap:8px}
.sb-logo .rbadge{font-size:10px;background:var(--accent);color:#fff;padding:2px 7px;border-radius:99px;font-weight:600}
.sb-user{padding:12px 16px;border-bottom:1px solid var(--border)}
.sb-user .uname{font-size:14px;font-weight:600}
.sb-user .urole{font-size:11px;color:var(--muted)}
.sb-nav{padding:10px 8px;flex:1}
.ns{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding:10px 8px 4px}
.ni{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;color:var(--muted);transition:all .15s;margin-bottom:2px;position:relative}
.ni:hover{background:var(--card);color:var(--text)}
.ni.active{background:var(--accent);color:#fff}
.ni .nb{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:99px;min-width:18px;text-align:center}
.sb-foot{padding:12px 8px;border-top:1px solid var(--border)}
.ni.logout{color:var(--danger)}
.ni.logout:hover{background:rgba(239,68,68,.1)}

/* MAIN */
.main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h2{font-size:20px;font-weight:700}
.ta{display:flex;align-items:center;gap:10px}
.content{padding:24px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border:none;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s}
.btn-p{background:var(--accent);color:#fff}
.btn-p:hover{background:#4f46e5}
.btn-g{background:var(--card);border:1px solid var(--border);color:var(--text)}
.btn-g:hover{background:var(--card2)}
.btn-d{background:var(--danger);color:#fff}
.btn-d:hover{background:#dc2626}
.btn-s{background:var(--success);color:#051b0b}
.btn-sm{padding:5px 10px;font-size:12px}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}

/* STATS */
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}
.sc{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;right:0;width:60px;height:60px;border-radius:0 14px 0 40px;opacity:.1}
.sc.blue::before{background:var(--accent)}
.sc.green::before{background:var(--success)}
.sc.orange::before{background:var(--warn)}
.sc.red::before{background:var(--danger)}
.sc-lbl{font-size:12px;color:var(--muted);font-weight:500}
.sc-val{font-size:32px;font-weight:800;margin:6px 0 2px}
.sc-sub{font-size:11px;color:var(--muted)}
.sc-icon{font-size:22px;margin-bottom:10px}
.sc.blue .sc-val{color:var(--accent-l)}
.sc.green .sc-val{color:var(--success)}
.sc.orange .sc-val{color:var(--warn)}
.sc.red .sc-val{color:var(--danger)}

/* FORMS */
.fg{margin-bottom:16px}
.fg label{display:block;font-size:11px;color:var(--muted);font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.fc{width:100%;padding:10px 13px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;transition:border-color .15s}
.fc:focus{border-color:var(--accent)}
.fc::placeholder{color:var(--muted)}
select.fc{cursor:pointer}
textarea.fc{min-height:88px;resize:vertical}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

/* TABLE */
.tw{overflow-x:auto}
table{width:100%;border-collapse:separate;border-spacing:0 4px}
th{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;padding:8px 12px}
td{padding:11px 12px;font-size:13px}
tr.lr td{background:var(--card2)}
tr.lr td:first-child{border-left:3px solid transparent;border-radius:8px 0 0 8px}
tr.lr.ov td:first-child{border-left-color:var(--danger)}
tr.lr.tod td:first-child{border-left-color:var(--warn)}
tr.lr:hover td{background:var(--card)}
td:first-child{border-radius:8px 0 0 8px}
td:last-child{border-radius:0 8px 8px 0}

/* STATUS */
.st{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:99px;font-size:11px;font-weight:600}
.st-fresh{background:rgba(99,102,241,.15);color:#818cf8}
.st-int{background:rgba(34,197,94,.15);color:#22c55e}
.st-no{background:rgba(239,68,68,.15);color:#f87171}
.st-cb{background:rgba(245,158,11,.15);color:#fbbf24}
.st-fu{background:rgba(56,189,248,.15);color:#38bdf8}
.st-conv{background:rgba(34,197,94,.25);color:#4ade80;border:1px solid rgba(34,197,94,.3)}
.st-lost{background:rgba(100,116,139,.15);color:#94a3b8}

/* ALERTS */
.al{padding:12px 16px;border-radius:12px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px}
.al-warn{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);color:var(--warn)}
.al-danger{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);color:#f87171}
.al-info{background:rgba(99,102,241,.1);border:1px solid rgba(99,102,241,.25);color:var(--accent-l)}

/* MODAL */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
.md{background:var(--card);border:1px solid var(--border);border-radius:18px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 30px 80px rgba(0,0,0,.6)}
.md-lg{max-width:820px}
.md-sm{max-width:400px}
.mh{padding:18px 24px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--card);z-index:1}
.mh h3{font-size:17px;font-weight:700}
.mc{padding:20px 24px}
.mf{padding:12px 24px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
.close-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;padding:4px 8px}
.close-btn:hover{color:var(--text)}

/* FILTERS */
.fb{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.fs{padding:8px 11px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;cursor:pointer;outline:none}
.fs:focus{border-color:var(--accent)}
.si{padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;outline:none;flex:1;min-width:200px}
.si:focus{border-color:var(--accent)}
.si::placeholder{color:var(--muted)}

/* TIMELINE */
.tl{position:relative}
.tl::before{content:'';position:absolute;left:16px;top:0;bottom:0;width:2px;background:var(--border)}
.tl-item{display:flex;gap:16px;padding-bottom:20px;position:relative}
.tl-dot{width:34px;height:34px;border-radius:50%;background:var(--card);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;z-index:1}
.tl-body{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px 14px}
.tl-meta{font-size:11px;color:var(--muted);margin-bottom:6px}

/* INFO GRID */
.ig{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.ii label{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px}
.ii span{font-size:14px;font-weight:500}

/* EMPTY */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .ei{font-size:48px;margin-bottom:12px;opacity:.5}

/* FOLLOWUP CARDS */
.fu-sec{margin-bottom:28px}
.fu-sec h3{font-size:16px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.fu-card{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;align-items:flex-start;gap:14px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.fu-card:hover{background:var(--card);border-color:var(--accent)}
.fu-card.ov{border-left:3px solid var(--danger)}
.fu-card.tod{border-left:3px solid var(--warn)}
.fu-name{font-size:14px;font-weight:600}
.fu-det{font-size:12px;color:var(--muted)}
.fu-date{font-size:12px;font-weight:600;white-space:nowrap}
.fu-date.ov{color:var(--danger)}
.fu-date.tod{color:var(--warn)}

/* AGENT CARDS */
.ac-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.ac{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
.ac-av{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;margin-bottom:0;background:var(--accent);color:#fff}
.ac-name{font-size:16px;font-weight:700}
.ac-role{font-size:12px;color:var(--muted);margin-bottom:12px}
.ac-stats{display:flex;gap:20px}
.ac-stat .val{font-size:22px;font-weight:700;color:var(--accent-l)}
.ac-stat .lbl{font-size:10px;color:var(--muted)}

@media(max-width:768px){
  .sb{width:100%;height:auto;position:relative}
  .main{margin-left:0}
  .fr,.fr3,.ig{grid-template-columns:1fr}
  .sg{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="ls">
  <div class="lb">
    <div class="ll"><h1>üéØ Team CRM</h1><p>Manage leads &amp; follow-ups</p></div>
    <div class="hint"><b>Demo Accounts:</b><br>Admin: <b>admin</b> / admin123 &nbsp;|&nbsp; Agent: <b>rahul</b> / rahul123 &nbsp;|&nbsp; priya / priya123 &nbsp;|&nbsp; arjun / arjun123</div>
    <div class="fg"><label>Username</label><input class="fc" id="lu" placeholder="Enter username" autocomplete="username"/></div>
    <div class="fg"><label>Password</label><input class="fc" id="lp" type="password" placeholder="Enter password" autocomplete="current-password"/></div>
    <div id="lerr" style="color:var(--danger);font-size:13px;margin-bottom:12px;display:none"></div>
    <button class="btn btn-p" style="width:100%;justify-content:center;padding:12px" onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="sb">
    <div class="sb-logo">üéØ CRM <span class="rbadge" id="rbadge"></span></div>
    <div class="sb-user"><div class="uname" id="uname"></div><div class="urole" id="urole"></div></div>
    <nav class="sb-nav">
      <div class="ns">Menu</div>
      <div class="ni active" data-p="dash" onclick="nav('dash')"><span>üìä</span>Dashboard</div>
      <div class="ni" data-p="leads" onclick="nav('leads')"><span>üë•</span>All Leads</div>
      <div class="ni" data-p="fu" onclick="nav('fu')"><span>üìÖ</span>Follow-ups<span class="nb" id="fub" style="display:none">0</span></div>
      <div id="adnav" style="display:none">
        <div class="ns">Admin</div>
        <div class="ni" data-p="team" onclick="nav('team')"><span>üë§</span>Team</div>
        <div class="ni" data-p="act" onclick="nav('act')"><span>üóÇ</span>All Activity</div>
      </div>
    </nav>
    <div class="sb-foot"><div class="ni logout" onclick="doLogout()"><span>üö™</span>Logout</div></div>
  </div>
  <div class="main">
    <div class="topbar"><h2 id="pt">Dashboard</h2><div class="ta" id="ta"></div></div>
    <div class="content" id="pc"></div>
  </div>
</div>

<!-- LEAD DETAIL MODAL -->
<div id="ldetail" class="mo" style="display:none" onclick="cmo('ldetail',event)">
  <div class="md md-lg" onclick="event.stopPropagation()">
    <div class="mh"><h3 id="ldt"></h3><button class="close-btn" onclick="cmo('ldetail')">‚úï</button></div>
    <div class="mc" id="ldb"></div>
  </div>
</div>

<!-- ADD/EDIT LEAD MODAL -->
<div id="lform" class="mo" style="display:none" onclick="cmo('lform',event)">
  <div class="md" onclick="event.stopPropagation()">
    <div class="mh"><h3 id="lft">Add Lead</h3><button class="close-btn" onclick="cmo('lform')">‚úï</button></div>
    <div class="mc">
      <div class="fr">
        <div class="fg"><label>Full Name *</label><input class="fc" id="lf-n" placeholder="John Doe"/></div>
        <div class="fg"><label>Phone Number *</label><input class="fc" id="lf-ph" placeholder="+91 98765 43210"/></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Email</label><input class="fc" id="lf-em" type="email" placeholder="john@example.com"/></div>
        <div class="fg"><label>Call Date *</label><input class="fc" id="lf-cd" type="date"/></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Brand Name</label><input class="fc" id="lf-br" placeholder="Company / Brand"/></div>
        <div class="fg"><label>Experience</label>
          <select class="fc" id="lf-ex">
            <option value="">Select Experience</option>
            <option>Fresher</option><option>0-1 years</option><option>1-3 years</option>
            <option>3-5 years</option><option>5-10 years</option><option>10+ years</option>
          </select>
        </div>
      </div>
      <div class="fr">
        <div class="fg"><label>Status / Remarks</label>
          <select class="fc" id="lf-st">
            <option>Fresh Lead</option><option>Interested</option><option>Not Interested</option>
            <option>Callback</option><option>Follow-up Scheduled</option><option>Converted</option><option>Lost</option>
          </select>
        </div>
        <div class="fg"><label>Next Follow-up Date</label><input class="fc" id="lf-fd" type="date"/></div>
      </div>
      <div class="fg" id="lf-asg-g" style="display:none"><label>Assign To</label><select class="fc" id="lf-asg"></select></div>
      <div class="fg"><label>Remarks / Notes</label><textarea class="fc" id="lf-rm" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="mf">
      <button class="btn btn-g" onclick="cmo('lform')">Cancel</button>
      <button class="btn btn-p" id="lf-sub" onclick="submitLead()">Add Lead</button>
    </div>
  </div>
</div>

<!-- ADD FOLLOW-UP MODAL -->
<div id="fumod" class="mo" style="display:none" onclick="cmo('fumod',event)">
  <div class="md" onclick="event.stopPropagation()">
    <div class="mh"><h3>Add Follow-up Note</h3><button class="close-btn" onclick="cmo('fumod')">‚úï</button></div>
    <div class="mc">
      <div id="fu-li" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:16px;font-size:13px"></div>
      <div class="fg"><label>Follow-up Notes *</label><textarea class="fc" id="fu-n" placeholder="What was discussed? Next steps?"></textarea></div>
      <div class="fr">
        <div class="fg"><label>Update Status</label>
          <select class="fc" id="fu-st">
            <option value="">-- Keep Current --</option>
            <option>Fresh Lead</option><option>Interested</option><option>Not Interested</option>
            <option>Callback</option><option>Follow-up Scheduled</option><option>Converted</option><option>Lost</option>
          </select>
        </div>
        <div class="fg"><label>Next Follow-up Date</label><input class="fc" id="fu-nd" type="date"/></div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-g" onclick="cmo('fumod')">Cancel</button>
      <button class="btn btn-p" onclick="submitFU()">Save Follow-up</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div id="delmod" class="mo" style="display:none" onclick="cmo('delmod',event)">
  <div class="md md-sm" onclick="event.stopPropagation()">
    <div class="mh"><h3>Confirm Delete</h3><button class="close-btn" onclick="cmo('delmod')">‚úï</button></div>
    <div class="mc"><p style="color:var(--muted)">Delete this lead and all its follow-up notes? This cannot be undone.</p></div>
    <div class="mf">
      <button class="btn btn-g" onclick="cmo('delmod')">Cancel</button>
      <button class="btn btn-d" id="delbtn">Delete</button>
    </div>
  </div>
</div>

<!-- ADD USER MODAL -->
<div id="umod" class="mo" style="display:none" onclick="cmo('umod',event)">
  <div class="md md-sm" onclick="event.stopPropagation()">
    <div class="mh"><h3>Add Team Member</h3><button class="close-btn" onclick="cmo('umod')">‚úï</button></div>
    <div class="mc">
      <div class="fr">
        <div class="fg"><label>Full Name *</label><input class="fc" id="um-n" placeholder="Full Name"/></div>
        <div class="fg"><label>Username *</label><input class="fc" id="um-u" placeholder="username"/></div>
      </div>
      <div class="fr">
        <div class="fg"><label>Password *</label><input class="fc" id="um-p" type="password" placeholder="password"/></div>
        <div class="fg"><label>Role</label>
          <select class="fc" id="um-r"><option value="agent">Agent</option><option value="admin">Admin</option></select>
        </div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-g" onclick="cmo('umod')">Cancel</button>
      <button class="btn btn-p" onclick="submitUser()">Add Member</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
const DB = {
  g: (k,d=[]) => { try{return JSON.parse(localStorage.getItem(k))||d}catch{return d} },
  s: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
  users: () => DB.g('crm_users'),
  saveU: u => DB.s('crm_users', u),
  leads: () => DB.g('crm_leads'),
  saveL: l => DB.s('crm_leads', l),
  fus: () => DB.g('crm_fus'),
  saveFU: f => DB.s('crm_fus', f)
};

const gid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const esc = s => s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';
const tod = () => new Date().toISOString().split('T')[0];
const fmt = d => { if(!d)return '‚Äî'; const dt=new Date(d); return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}); };
const fmtDT = d => { if(!d)return '‚Äî'; const dt=new Date(d); return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); };

// ‚îÄ‚îÄ INIT DATA ‚îÄ‚îÄ
function initData() {
  if (DB.users().length) return;
  const now = new Date().toISOString();
  DB.saveU([
    {id:'u1',name:'Super Admin',username:'admin',password:'admin123',role:'admin',createdAt:now},
    {id:'u2',name:'Rahul Sharma',username:'rahul',password:'rahul123',role:'agent',createdAt:now},
    {id:'u3',name:'Priya Patel',username:'priya',password:'priya123',role:'agent',createdAt:now},
    {id:'u4',name:'Arjun Singh',username:'arjun',password:'arjun123',role:'agent',createdAt:now}
  ]);
  const d = new Date();
  const df = (off) => { const x=new Date(d); x.setDate(x.getDate()+off); return x.toISOString().split('T')[0]; };
  const dc = (off) => { const x=new Date(d); x.setDate(x.getDate()+off); return x.toISOString(); };
  DB.saveL([
    {id:gid(),name:'Kiran Mehta',phone:'+91 98765 43210',email:'kiran@example.com',callDate:df(-4),brandName:'TechStart Solutions',experience:'3-5 years',status:'Interested',followUpDate:tod(),remarks:'Very interested, needs to discuss fees with manager.',assignedTo:'u2',createdBy:'u2',createdAt:dc(-4)},
    {id:gid(),name:'Sneha Kapoor',phone:'+91 87654 32109',email:'sneha@example.com',callDate:df(-2),brandName:'Digital First Agency',experience:'1-3 years',status:'Callback',followUpDate:df(-1),remarks:'Requested callback in the evening.',assignedTo:'u2',createdBy:'u2',createdAt:dc(-2)},
    {id:gid(),name:'Rohan Verma',phone:'+91 76543 21098',email:'rohan@example.com',callDate:tod(),brandName:'StartupHub',experience:'Fresher',status:'Fresh Lead',followUpDate:df(2),remarks:'',assignedTo:'u3',createdBy:'u3',createdAt:dc(0)},
    {id:gid(),name:'Anita Singh',phone:'+91 65432 10987',email:'anita@example.com',callDate:df(-5),brandName:'Apex Corp',experience:'5-10 years',status:'Converted',followUpDate:'',remarks:'Enrolled successfully. Payment received.',assignedTo:'u3',createdBy:'u3',createdAt:dc(-5)},
    {id:gid(),name:'Deepak Kumar',phone:'+91 54321 09876',email:'deepak@example.com',callDate:df(-1),brandName:'NextGen Tech',experience:'0-1 years',status:'Not Interested',followUpDate:'',remarks:'Budget constraints at the moment.',assignedTo:'u4',createdBy:'u4',createdAt:dc(-1)},
    {id:gid(),name:'Meera Joshi',phone:'+91 43210 98765',email:'meera@example.com',callDate:df(-3),brandName:'Bright Minds',experience:'10+ years',status:'Follow-up Scheduled',followUpDate:tod(),remarks:'Senior professional. Needs weekend batch info.',assignedTo:'u4',createdBy:'u4',createdAt:dc(-3)}
  ]);
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
let CU = null;

function doLogin() {
  const u = document.getElementById('lu').value.trim();
  const p = document.getElementById('lp').value;
  const user = DB.users().find(x => x.username===u && x.password===p);
  const err = document.getElementById('lerr');
  if (!user) { err.textContent='Invalid username or password.'; err.style.display='block'; return; }
  err.style.display='none';
  CU = user;
  sessionStorage.setItem('crm_sess', JSON.stringify({id:user.id}));
  showApp();
}

function doLogout() {
  CU = null;
  sessionStorage.removeItem('crm_sess');
  document.getElementById('app').style.display='none';
  document.getElementById('ls').style.display='flex';
  document.getElementById('lu').value='';
  document.getElementById('lp').value='';
}

function restoreSession() {
  try {
    const s = sessionStorage.getItem('crm_sess');
    if (!s) return false;
    const {id} = JSON.parse(s);
    const u = DB.users().find(x=>x.id===id);
    if (!u) return false;
    CU = u; return true;
  } catch { return false; }
}

function showApp() {
  document.getElementById('ls').style.display='none';
  document.getElementById('app').style.display='flex';
  document.getElementById('uname').textContent = CU.name;
  document.getElementById('urole').textContent = CU.role==='admin' ? 'üëë Super Admin' : 'üë§ Agent';
  document.getElementById('rbadge').textContent = CU.role==='admin' ? 'Admin' : 'Agent';
  document.getElementById('adnav').style.display = CU.role==='admin' ? 'block' : 'none';
  updBadge();
  nav('dash');
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
let CP = 'dash';
const TITLES = {dash:'Dashboard',leads:'All Leads',fu:'Follow-ups',team:'Team Overview',act:'All Activity'};

function nav(p) {
  CP = p;
  document.querySelectorAll('.ni[data-p]').forEach(el => el.classList.toggle('active', el.dataset.p===p));
  document.getElementById('pt').textContent = TITLES[p]||p;
  updBadge();
  renderPage(p);
}

function renderPage(p) {
  const c = document.getElementById('pc'), ta = document.getElementById('ta');
  switch(p) {
    case 'dash': rDash(c,ta); break;
    case 'leads': rLeads(c,ta); break;
    case 'fu': rFU(c,ta); break;
    case 'team': rTeam(c,ta); break;
    case 'act': rAct(c,ta); break;
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function stCls(s) {
  return {
    'Fresh Lead':'st-fresh','Interested':'st-int','Not Interested':'st-no',
    'Callback':'st-cb','Follow-up Scheduled':'st-fu','Converted':'st-conv','Lost':'st-lost'
  }[s]||'st-fresh';
}
function stEmoji(s) {
  return {'Fresh Lead':'üÜï','Interested':'üí°','Not Interested':'‚ùå','Callback':'üìû',
    'Follow-up Scheduled':'üìÖ','Converted':'‚úÖ','Lost':'üö´'}[s]||'‚Ä¢';
}
function fuSt(lead) {
  if (!lead.followUpDate) return 'none';
  if (lead.followUpDate < tod()) return 'ov';
  if (lead.followUpDate === tod()) return 'tod';
  return 'up';
}
function myLeads() {
  const ls = DB.leads();
  return CU.role==='admin' ? ls : ls.filter(l=>l.assignedTo===CU.id||l.createdBy===CU.id);
}
function uName(id) { const u=DB.users().find(x=>x.id===id); return u?u.name:'Unknown'; }
function updBadge() {
  const n = myLeads().filter(l=>['ov','tod'].includes(fuSt(l))).length;
  const b=document.getElementById('fub');
  if(!b)return;
  b.style.display = n?'inline-block':'none';
  b.textContent = n;
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function rDash(c,ta) {
  ta.innerHTML = `<button class="btn btn-p" onclick="openAddLead()">+ Add Lead</button>`;
  const ls = myLeads();
  const total=ls.length, conv=ls.filter(l=>l.status==='Converted').length;
  const ov=ls.filter(l=>fuSt(l)==='ov').length, t=ls.filter(l=>fuSt(l)==='tod').length;
  const cr = total?Math.round(conv/total*100):0;
  let h = `<div class="sg">
    <div class="sc blue"><div class="sc-icon">üë•</div><div class="sc-lbl">Total Leads</div><div class="sc-val">${total}</div><div class="sc-sub">${CU.role==='admin'?'All team leads':'Your leads'}</div></div>
    <div class="sc green"><div class="sc-icon">‚úÖ</div><div class="sc-lbl">Converted</div><div class="sc-val">${conv}</div><div class="sc-sub">Conversion rate: ${cr}%</div></div>
    <div class="sc orange"><div class="sc-icon">üìÖ</div><div class="sc-lbl">Due Today</div><div class="sc-val">${t}</div><div class="sc-sub">Follow-ups today</div></div>
    <div class="sc red"><div class="sc-icon">‚ö†Ô∏è</div><div class="sc-lbl">Overdue</div><div class="sc-val">${ov}</div><div class="sc-sub">Missed follow-ups</div></div>
  </div>`;
  if (ov>0) h+=`<div class="al al-danger">‚ö†Ô∏è <strong>${ov} overdue follow-up${ov>1?'s':''}</strong> ‚Äî take action now!</div>`;
  if (t>0) h+=`<div class="al al-warn">üìÖ <strong>${t} follow-up${t>1?'s':''} due today</strong> ‚Äî don't miss them!</div>`;
  const urgent = ls.filter(l=>['ov','tod'].includes(fuSt(l))).sort((a,b)=>a.followUpDate.localeCompare(b.followUpDate));
  if (urgent.length) {
    h+=`<div class="card" style="margin-bottom:20px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><b>üîî Urgent Follow-ups</b><button class="btn btn-sm btn-g" onclick="nav('fu')">View All</button></div>`;
    h+=urgent.slice(0,5).map(l=>{
      const fs=fuSt(l);
      return `<div class="fu-card ${fs}" onclick="openDetail('${l.id}')">
        <div style="flex:1"><div class="fu-name">${esc(l.name)}</div><div class="fu-det">${esc(l.phone)} ¬∑ ${esc(l.brandName||'‚Äî')} ¬∑ <span class="st ${stCls(l.status)}" style="font-size:10px">${l.status}</span></div></div>
        <div class="fu-date ${fs}">${fs==='ov'?'‚ö†Ô∏è Overdue':'üìÖ Today'} ¬∑ ${fmt(l.followUpDate)}</div>
      </div>`;
    }).join('');
    h+='</div>';
  }
  const recent = ls.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
  h+=`<div class="card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><b>üïê Recent Leads</b><button class="btn btn-sm btn-g" onclick="nav('leads')">View All</button></div>`;
  if (!recent.length) h+=`<div class="empty"><div class="ei">üìã</div><p>No leads yet. Add your first lead!</p></div>`;
  else h+=`<div class="tw"><table><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Follow-up</th><th>Added</th></tr></thead><tbody>
    ${recent.map(l=>{const fs=fuSt(l);return `<tr class="lr ${fs}" onclick="openDetail('${l.id}')" style="cursor:pointer">
      <td><b>${esc(l.name)}</b><div style="font-size:11px;color:var(--muted)">${esc(l.brandName||'')}</div></td>
      <td>${esc(l.phone)}</td>
      <td><span class="st ${stCls(l.status)}">${stEmoji(l.status)} ${l.status}</span></td>
      <td>${l.followUpDate?`<span style="color:${fs==='ov'?'var(--danger)':fs==='tod'?'var(--warn)':'inherit'}">${fmt(l.followUpDate)}</span>`:'‚Äî'}</td>
      <td style="color:var(--muted);font-size:12px">${fmt(l.callDate)}</td>
    </tr>`;}).join('')}
  </tbody></table></div>`;
  h+='</div>';
  c.innerHTML=h;
}

// ‚îÄ‚îÄ LEADS PAGE ‚îÄ‚îÄ
let LF = {q:'',st:'',ex:'',fup:'',ag:'',df:'',dt:''};

function rLeads(c,ta) {
  ta.innerHTML=`<button class="btn btn-p" onclick="openAddLead()">+ Add Lead</button>`;
  const all = myLeads();
  let fl = all.filter(l=>{
    if(LF.q){const q=LF.q.toLowerCase();if(!l.name.toLowerCase().includes(q)&&!l.phone.includes(q)&&!(l.email||'').toLowerCase().includes(q)&&!(l.brandName||'').toLowerCase().includes(q))return false;}
    if(LF.st&&l.status!==LF.st)return false;
    if(LF.ex&&l.experience!==LF.ex)return false;
    if(LF.ag&&l.assignedTo!==LF.ag)return false;
    if(LF.fup){const fs=fuSt(l);if(LF.fup==='ov'&&fs!=='ov')return false;if(LF.fup==='tod'&&fs!=='tod')return false;if(LF.fup==='up'&&fs!=='up')return false;if(LF.fup==='none'&&l.followUpDate)return false;}
    if(LF.df&&l.callDate<LF.df)return false;
    if(LF.dt&&l.callDate>LF.dt)return false;
    return true;
  }).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  const hasFilt = Object.values(LF).some(v=>v);
  const rr = () => rLeads(document.getElementById('pc'),document.getElementById('ta'));

  let h=`<div class="fb">
    <input class="si" placeholder="üîç Search name, phone, email, brand..." value="${esc(LF.q)}" oninput="LF.q=this.value;${rr.toString().replace(/\n/g,'')}()"/>
    <select class="fs" onchange="LF.st=this.value;rLeads(document.getElementById('pc'),document.getElementById('ta'))">
      <option value="">All Status</option>
      ${['Fresh Lead','Interested','Not Interested','Callback','Follow-up Scheduled','Converted','Lost'].map(s=>`<option value="${s}" ${LF.st===s?'selected':''}>${s}</option>`).join('')}
    </select>
    <select class="fs" onchange="LF.ex=this.value;rLeads(document.getElementById('pc'),document.getElementById('ta'))">
      <option value="">All Experience</option>
      ${['Fresher','0-1 years','1-3 years','3-5 years','5-10 years','10+ years'].map(e=>`<option value="${e}" ${LF.ex===e?'selected':''}>${e}</option>`).join('')}
    </select>
    <select class="fs" onchange="LF.fup=this.value;rLeads(document.getElementById('pc'),document.getElementById('ta'))">
      <option value="">All Follow-ups</option>
      <option value="ov" ${LF.fup==='ov'?'selected':''}>Overdue</option>
      <option value="tod" ${LF.fup==='tod'?'selected':''}>Due Today</option>
      <option value="up" ${LF.fup==='up'?'selected':''}>Upcoming</option>
      <option value="none" ${LF.fup==='none'?'selected':''}>No Follow-up</option>
    </select>
    ${CU.role==='admin'?`<select class="fs" onchange="LF.ag=this.value;rLeads(document.getElementById('pc'),document.getElementById('ta'))"><option value="">All Agents</option>${DB.users().map(u=>`<option value="${u.id}" ${LF.ag===u.id?'selected':''}>${esc(u.name)}</option>`).join('')}</select>`:''}
    <input type="date" class="fs" title="From Call Date" value="${LF.df}" onchange="LF.df=this.value;rLeads(document.getElementById('pc'),document.getElementById('ta'))"/>
    <input type="date" class="fs" title="To Call Date" value="${LF.dt}" onchange="LF.dt=this.value;rLeads(document.getElementById('pc'),document.getElementById('ta'))"/>
    ${hasFilt?`<button class="btn btn-sm btn-g" onclick="LF={q:'',st:'',ex:'',fup:'',ag:'',df:'',dt:''};rLeads(document.getElementById('pc'),document.getElementById('ta'))">‚úï Clear</button>`:''}
  </div>
  <div style="margin-bottom:10px;color:var(--muted);font-size:13px">${fl.length} lead${fl.length!==1?'s':''} found</div>`;

  if (!fl.length) {
    h+=`<div class="empty"><div class="ei">üîç</div><p>No leads match your filters.</p></div>`;
  } else {
    h+=`<div class="card" style="padding:0;overflow:hidden"><div class="tw"><table>
      <thead><tr>
        <th style="padding-left:18px">Lead</th><th>Contact</th><th>Experience</th>
        <th>Status</th><th>Follow-up</th>
        ${CU.role==='admin'?'<th>Agent</th>':''}
        <th>Call Date</th><th>Actions</th>
      </tr></thead><tbody>
      ${fl.map(l=>{
        const fs=fuSt(l);
        return `<tr class="lr ${fs}" onclick="openDetail('${l.id}')" style="cursor:pointer">
          <td style="padding-left:18px"><b>${esc(l.name)}</b><div style="font-size:11px;color:var(--muted)">${esc(l.brandName||'‚Äî')}</div></td>
          <td><div>${esc(l.phone)}</div><div style="font-size:11px;color:var(--muted)">${esc(l.email||'')}</div></td>
          <td style="color:var(--muted)">${esc(l.experience||'‚Äî')}</td>
          <td><span class="st ${stCls(l.status)}">${stEmoji(l.status)} ${l.status}</span></td>
          <td>${l.followUpDate?`<span style="color:${fs==='ov'?'var(--danger)':fs==='tod'?'var(--warn)':'inherit'}">${fs==='ov'?'‚ö†Ô∏è ':fs==='tod'?'üìÖ ':'üóì '}${fmt(l.followUpDate)}</span>`:'‚Äî'}</td>
          ${CU.role==='admin'?`<td style="font-size:12px;color:var(--muted)">${esc(uName(l.assignedTo))}</td>`:''}
          <td style="font-size:12px;color:var(--muted)">${fmt(l.callDate)}</td>
          <td onclick="event.stopPropagation()"><div style="display:flex;gap:5px">
            <button class="btn btn-sm btn-p" onclick="openFU('${l.id}')">+ Note</button>
            <button class="btn btn-sm btn-g" onclick="openEditLead('${l.id}')">‚úèÔ∏è</button>
            ${CU.role==='admin'?`<button class="btn btn-sm btn-d" onclick="confirmDel('${l.id}')">üóë</button>`:''}
          </div></td>
        </tr>`;
      }).join('')}
      </tbody></table></div></div>`;
  }
  c.innerHTML=h;
}

// ‚îÄ‚îÄ FOLLOW-UPS PAGE ‚îÄ‚îÄ
function rFU(c,ta) {
  ta.innerHTML=`<button class="btn btn-p" onclick="openAddLead()">+ Add Lead</button>`;
  const ls=myLeads();
  const ov=ls.filter(l=>fuSt(l)==='ov').sort((a,b)=>a.followUpDate.localeCompare(b.followUpDate));
  const t=ls.filter(l=>fuSt(l)==='tod');
  const up=ls.filter(l=>fuSt(l)==='up').sort((a,b)=>a.followUpDate.localeCompare(b.followUpDate));
  let h='';
  if (!ov.length&&!t.length&&!up.length) { h=`<div class="empty"><div class="ei">‚úÖ</div><p>You're all caught up! No follow-ups scheduled.</p></div>`; }
  const fc=(l,cls,lbl,col)=>`<div class="fu-card ${cls}" onclick="openDetail('${l.id}')">
    <div style="flex:1">
      <div class="fu-name">${esc(l.name)} <span class="st ${stCls(l.status)}" style="font-size:10px">${l.status}</span></div>
      <div class="fu-det">${esc(l.phone)} ¬∑ ${esc(l.brandName||'‚Äî')} ¬∑ ${esc(l.experience||'‚Äî')}</div>
      ${l.remarks?`<div style="font-size:12px;color:var(--muted);margin-top:4px">üìù ${esc(l.remarks.slice(0,80))}${l.remarks.length>80?'...':''}</div>`:''}
    </div>
    <div style="text-align:right">
      <div class="fu-date ${cls}" style="color:${col}">${lbl}</div>
      <div style="font-size:11px;color:var(--muted)">${fmt(l.followUpDate)}</div>
      <div style="margin-top:8px;display:flex;gap:5px;justify-content:flex-end">
        <button class="btn btn-sm btn-p" onclick="event.stopPropagation();openFU('${l.id}')">+ Note</button>
        <button class="btn btn-sm btn-g" onclick="event.stopPropagation();openEditLead('${l.id}')">Edit</button>
      </div>
    </div>
  </div>`;
  if(ov.length) h+=`<div class="fu-sec"><h3>‚ö†Ô∏è Overdue <span style="font-size:13px;color:var(--danger);font-weight:500">(${ov.length})</span></h3>${ov.map(l=>fc(l,'ov','‚ö†Ô∏è OVERDUE','var(--danger)')).join('')}</div>`;
  if(t.length) h+=`<div class="fu-sec"><h3>üìÖ Due Today <span style="font-size:13px;color:var(--warn);font-weight:500">(${t.length})</span></h3>${t.map(l=>fc(l,'tod','üìÖ Today','var(--warn)')).join('')}</div>`;
  if(up.length) h+=`<div class="fu-sec"><h3>üóì Upcoming <span style="font-size:13px;color:var(--muted);font-weight:500">(${up.length})</span></h3>${up.map(l=>fc(l,'','üóì Scheduled','var(--text)')).join('')}</div>`;
  c.innerHTML=h;
}

// ‚îÄ‚îÄ TEAM PAGE ‚îÄ‚îÄ
function rTeam(c,ta) {
  ta.innerHTML=`<button class="btn btn-p" onclick="openAddUser()">+ Add Member</button>`;
  const us=DB.users(), ls=DB.leads();
  let h=`<div class="ac-grid">`;
  us.forEach(u=>{
    const ul=ls.filter(l=>l.assignedTo===u.id||l.createdBy===u.id);
    const conv=ul.filter(l=>l.status==='Converted').length;
    const ov=ul.filter(l=>fuSt(l)==='ov').length;
    const col=u.role==='admin'?'var(--accent)':'#0891b2';
    h+=`<div class="ac">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
        <div class="ac-av" style="background:${col}">${u.name.charAt(0)}</div>
        <div><div class="ac-name">${esc(u.name)}</div><div class="ac-role">${u.role==='admin'?'üëë Super Admin':'üë§ Agent'} ¬∑ @${esc(u.username)}</div></div>
      </div>
      <div class="ac-stats">
        <div class="ac-stat"><div class="val">${ul.length}</div><div class="lbl">Leads</div></div>
        <div class="ac-stat"><div class="val" style="color:var(--success)">${conv}</div><div class="lbl">Converted</div></div>
        <div class="ac-stat"><div class="val" style="color:var(--danger)">${ov}</div><div class="lbl">Overdue</div></div>
      </div>
      ${u.id!==CU.id?`<button class="btn btn-sm btn-d" style="margin-top:12px;width:100%" onclick="delUser('${u.id}')">Remove Member</button>`:'<div style="margin-top:12px;font-size:12px;color:var(--muted);text-align:center">That\'s you!</div>'}
    </div>`;
  });
  h+=`</div>`;
  c.innerHTML=h;
}

// ‚îÄ‚îÄ ALL ACTIVITY ‚îÄ‚îÄ
function rAct(c,ta) {
  ta.innerHTML='';
  const ls=DB.leads(), fs=DB.fus();
  const ev=[
    ...ls.map(l=>({type:'lead',ts:l.createdAt,d:l})),
    ...fs.map(f=>({type:'fu',ts:f.createdAt,d:f}))
  ].sort((a,b)=>new Date(b.ts)-new Date(a.ts)).slice(0,60);
  let h=`<div class="card"><div style="margin-bottom:16px;font-weight:700">Recent Activity (last 60)</div><div class="tl">`;
  if(!ev.length) h+=`<div class="empty" style="padding:30px"><p>No activity yet.</p></div>`;
  ev.forEach(e=>{
    if(e.type==='lead'){
      const l=e.d;
      h+=`<div class="tl-item"><div class="tl-dot">üë§</div><div class="tl-body"><div class="tl-meta">${fmtDT(l.createdAt)} ¬∑ by ${esc(uName(l.createdBy))}</div><div><b>New Lead:</b> ${esc(l.name)} ¬∑ ${esc(l.phone)} ¬∑ <span class="st ${stCls(l.status)}">${l.status}</span></div></div></div>`;
    } else {
      const f=e.d, lead=ls.find(l=>l.id===f.leadId);
      h+=`<div class="tl-item"><div class="tl-dot">üìù</div><div class="tl-body"><div class="tl-meta">${fmtDT(f.createdAt)} ¬∑ by ${esc(uName(f.createdBy))}</div><div><b>Follow-up on:</b> ${lead?esc(lead.name):'Unknown Lead'}<br>${esc(f.notes)}</div>${f.statusChanged?`<div style="margin-top:6px"><span class="st ${stCls(f.statusChanged)}" style="font-size:10px">${f.statusChanged}</span></div>`:''}</div></div>`;
    }
  });
  h+=`</div></div>`;
  c.innerHTML=h;
}

// ‚îÄ‚îÄ LEAD DETAIL ‚îÄ‚îÄ
function openDetail(id) {
  const lead=DB.leads().find(l=>l.id===id);
  if(!lead)return;
  const fus=DB.fus().filter(f=>f.leadId===id).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  const fs=fuSt(lead);
  document.getElementById('ldt').textContent=lead.name;
  let b=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center">
    <span class="st ${stCls(lead.status)}" style="font-size:13px">${stEmoji(lead.status)} ${lead.status}</span>
    ${lead.followUpDate?`<span class="st ${fs==='ov'?'st-no':fs==='tod'?'st-cb':'st-fu'}">üìÖ Follow-up: ${fmt(lead.followUpDate)}</span>`:''}
    ${CU.role==='admin'?`<span style="font-size:12px;color:var(--muted)">üë§ ${esc(uName(lead.assignedTo))}</span>`:''}
  </div>
  <div class="ig">
    <div class="ii"><label>Phone</label><span><a href="tel:${esc(lead.phone)}" style="color:var(--accent-l);text-decoration:none">${esc(lead.phone)}</a></span></div>
    <div class="ii"><label>Email</label><span>${lead.email?`<a href="mailto:${esc(lead.email)}" style="color:var(--accent-l);text-decoration:none">${esc(lead.email)}</a>`:'‚Äî'}</span></div>
    <div class="ii"><label>Brand Name</label><span>${esc(lead.brandName||'‚Äî')}</span></div>
    <div class="ii"><label>Experience</label><span>${esc(lead.experience||'‚Äî')}</span></div>
    <div class="ii"><label>Call Date</label><span>${fmt(lead.callDate)}</span></div>
    <div class="ii"><label>Added On</label><span>${fmtDT(lead.createdAt)}</span></div>
  </div>
  ${lead.remarks?`<div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:16px"><div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:6px">Remarks</div><div style="font-size:13px">${esc(lead.remarks)}</div></div>`:''}
  <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
    <button class="btn btn-p" onclick="openFU('${lead.id}')">+ Add Follow-up Note</button>
    <button class="btn btn-g" onclick="openEditLead('${lead.id}');cmo('ldetail')">‚úèÔ∏è Edit Lead</button>
    ${CU.role==='admin'?`<button class="btn btn-d" onclick="confirmDel('${lead.id}');cmo('ldetail')">üóë Delete</button>`:''}
  </div>
  <div style="font-size:15px;font-weight:700;margin-bottom:14px">üìù Follow-up History (${fus.length})</div>`;
  if(!fus.length) b+=`<div class="empty" style="padding:30px 20px"><div class="ei" style="font-size:32px">üìã</div><p>No follow-up notes yet. Add the first one!</p></div>`;
  else b+=`<div class="tl">${fus.map(f=>`<div class="tl-item"><div class="tl-dot">üìù</div><div class="tl-body">
    <div class="tl-meta">${fmtDT(f.createdAt)} ¬∑ by ${esc(uName(f.createdBy))}</div>
    <div style="font-size:13px">${esc(f.notes)}</div>
    ${f.statusChanged?`<div style="margin-top:6px"><span class="st ${stCls(f.statusChanged)}" style="font-size:11px">‚Üí ${f.statusChanged}</span></div>`:''}
    ${f.nextFollowUpDate?`<div style="margin-top:6px;font-size:11px;color:var(--muted)">üìÖ Next follow-up: ${fmt(f.nextFollowUpDate)}</div>`:''}
  </div></div>`).join('')}</div>`;
  document.getElementById('ldb').innerHTML=b;
  document.getElementById('ldetail').style.display='flex';
}

// ‚îÄ‚îÄ ADD/EDIT LEAD ‚îÄ‚îÄ
let ELI = null;

function openAddLead() {
  ELI=null;
  document.getElementById('lft').textContent='Add New Lead';
  document.getElementById('lf-sub').textContent='Add Lead';
  ['lf-n','lf-ph','lf-em','lf-br','lf-rm','lf-fd'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('lf-cd').value=tod();
  document.getElementById('lf-ex').value='';
  document.getElementById('lf-st').value='Fresh Lead';
  const ag=document.getElementById('lf-asg-g');
  if(CU.role==='admin'){
    ag.style.display='block';
    const sel=document.getElementById('lf-asg');
    sel.innerHTML=DB.users().map(u=>`<option value="${u.id}">${esc(u.name)} (${u.role})</option>`).join('');
    sel.value=CU.id;
  } else ag.style.display='none';
  document.getElementById('lform').style.display='flex';
}

function openEditLead(id) {
  const l=DB.leads().find(x=>x.id===id);
  if(!l)return;
  ELI=id;
  document.getElementById('lft').textContent='Edit Lead';
  document.getElementById('lf-sub').textContent='Save Changes';
  document.getElementById('lf-n').value=l.name;
  document.getElementById('lf-ph').value=l.phone;
  document.getElementById('lf-em').value=l.email||'';
  document.getElementById('lf-cd').value=l.callDate;
  document.getElementById('lf-br').value=l.brandName||'';
  document.getElementById('lf-ex').value=l.experience||'';
  document.getElementById('lf-st').value=l.status;
  document.getElementById('lf-fd').value=l.followUpDate||'';
  document.getElementById('lf-rm').value=l.remarks||'';
  const ag=document.getElementById('lf-asg-g');
  if(CU.role==='admin'){
    ag.style.display='block';
    const sel=document.getElementById('lf-asg');
    sel.innerHTML=DB.users().map(u=>`<option value="${u.id}">${esc(u.name)} (${u.role})</option>`).join('');
    sel.value=l.assignedTo;
  } else ag.style.display='none';
  document.getElementById('lform').style.display='flex';
}

function submitLead() {
  const n=document.getElementById('lf-n').value.trim();
  const ph=document.getElementById('lf-ph').value.trim();
  const cd=document.getElementById('lf-cd').value;
  if(!n||!ph||!cd){alert('Name, Phone and Call Date are required.');return;}
  const asg=CU.role==='admin'?document.getElementById('lf-asg').value:CU.id;
  const ls=DB.leads();
  const data={
    name:n,phone:ph,email:document.getElementById('lf-em').value.trim(),
    callDate:cd,brandName:document.getElementById('lf-br').value.trim(),
    experience:document.getElementById('lf-ex').value,status:document.getElementById('lf-st').value,
    followUpDate:document.getElementById('lf-fd').value,remarks:document.getElementById('lf-rm').value.trim(),
    assignedTo:asg
  };
  if(ELI){
    const i=ls.findIndex(l=>l.id===ELI);
    if(i!==-1)ls[i]={...ls[i],...data,updatedAt:new Date().toISOString()};
  } else {
    ls.push({id:gid(),...data,createdBy:CU.id,createdAt:new Date().toISOString()});
  }
  DB.saveL(ls);
  cmo('lform');
  updBadge();
  renderPage(CP);
}

// ‚îÄ‚îÄ FOLLOW-UP ‚îÄ‚îÄ
let FUI = null;

function openFU(id) {
  const l=DB.leads().find(x=>x.id===id);
  if(!l)return;
  FUI=id;
  document.getElementById('fu-li').innerHTML=`<b>${esc(l.name)}</b> ¬∑ ${esc(l.phone)}<br><span class="st ${stCls(l.status)}" style="font-size:11px">${l.status}</span>${l.followUpDate?` ¬∑ Last follow-up: ${fmt(l.followUpDate)}`:''}`;
  ['fu-n'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('fu-st').value='';
  document.getElementById('fu-nd').value='';
  document.getElementById('fumod').style.display='flex';
}

function submitFU() {
  const notes=document.getElementById('fu-n').value.trim();
  if(!notes){alert('Please add your follow-up notes.');return;}
  const nst=document.getElementById('fu-st').value;
  const nd=document.getElementById('fu-nd').value;
  const fus=DB.fus();
  fus.push({id:gid(),leadId:FUI,notes,statusChanged:nst||null,nextFollowUpDate:nd||null,createdBy:CU.id,createdAt:new Date().toISOString()});
  DB.saveFU(fus);
  if(nst||nd){
    const ls=DB.leads(), i=ls.findIndex(l=>l.id===FUI);
    if(i!==-1){if(nst)ls[i].status=nst;if(nd)ls[i].followUpDate=nd;ls[i].updatedAt=new Date().toISOString();DB.saveL(ls);}
  }
  cmo('fumod');
  updBadge();
  if(document.getElementById('ldetail').style.display!=='none')openDetail(FUI);
  renderPage(CP);
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
function confirmDel(id) {
  document.getElementById('delbtn').onclick=()=>{
    DB.saveL(DB.leads().filter(l=>l.id!==id));
    DB.saveFU(DB.fus().filter(f=>f.leadId!==id));
    cmo('delmod');cmo('ldetail');
    updBadge();renderPage(CP);
  };
  document.getElementById('delmod').style.display='flex';
}

// ‚îÄ‚îÄ USER MANAGEMENT ‚îÄ‚îÄ
function openAddUser() {
  ['um-n','um-u','um-p'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('um-r').value='agent';
  document.getElementById('umod').style.display='flex';
}

function submitUser() {
  const n=document.getElementById('um-n').value.trim();
  const u=document.getElementById('um-u').value.trim().toLowerCase();
  const p=document.getElementById('um-p').value;
  const r=document.getElementById('um-r').value;
  if(!n||!u||!p){alert('All fields required.');return;}
  const us=DB.users();
  if(us.find(x=>x.username===u)){alert('Username already exists.');return;}
  us.push({id:gid(),name:n,username:u,password:p,role:r,createdAt:new Date().toISOString()});
  DB.saveU(us);cmo('umod');renderPage(CP);
}

function delUser(id) {
  if(!confirm('Remove this team member? Their leads will remain.'))return;
  DB.saveU(DB.users().filter(u=>u.id!==id));
  renderPage('team');
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function cmo(id,ev) {
  if(ev&&ev.target!==document.getElementById(id))return;
  document.getElementById(id).style.display='none';
}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape')['ldetail','lform','fumod','delmod','umod'].forEach(id=>document.getElementById(id).style.display='none');
});

document.getElementById('lp').addEventListener('keydown',e=>e.key==='Enter'&&doLogin());
document.getElementById('lu').addEventListener('keydown',e=>e.key==='Enter'&&document.getElementById('lp').focus());

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
initData();
if(restoreSession())showApp();
</script>
</body>
</html>